<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dify å·¥ä½œæµåŠ©æ‰‹</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for code highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Markdown æ ·å¼ */
        .prose p { margin-bottom: 0.75rem; line-height: 1.7; }
        .prose p:last-child { margin-bottom: 0; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.75rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 0.75rem; }
        .prose li { margin-bottom: 0.25rem; }
        .prose pre { 
            background-color: #1e293b; 
            padding: 1rem; 
            border-radius: 0.5rem; 
            overflow-x: auto; 
            font-size: 0.875em; 
            margin: 0.75rem 0;
        }
        .prose pre code { 
            background-color: transparent; 
            color: #e2e8f0; 
            padding: 0; 
            font-family: 'Fira Code', 'Monaco', monospace;
        }
        .prose code { 
            background-color: #f1f5f9; 
            padding: 0.15rem 0.4rem; 
            border-radius: 0.25rem; 
            font-family: 'Fira Code', 'Monaco', monospace;
            font-size: 0.9em; 
            color: #dc2626; 
        }
        .prose h1, .prose h2, .prose h3 { font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }
        .prose h1 { font-size: 1.5em; }
        .prose h2 { font-size: 1.25em; }
        .prose h3 { font-size: 1.1em; }
        .prose blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 1rem;
            margin: 0.75rem 0;
            color: #64748b;
            background-color: #f8fafc;
            padding: 0.5rem 1rem;
            border-radius: 0 0.5rem 0.5rem 0;
        }
        .prose table { width: 100%; border-collapse: collapse; margin: 0.75rem 0; }
        .prose th, .prose td { border: 1px solid #e2e8f0; padding: 0.5rem; text-align: left; }
        .prose th { background-color: #f8fafc; font-weight: 600; }
        
        /* æ¶ˆæ¯æ°”æ³¡åŠ¨ç”» */
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .message-anim { animation: fadeIn 0.3s ease-out forwards; }

        /* æ‰“å­—å…‰æ ‡ */
        .cursor::after { 
            content: 'â–‹'; 
            display: inline-block; 
            vertical-align: bottom; 
            animation: blink 1s infinite; 
            color: #8b5cf6; 
            margin-left: 2px; 
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .cursor.typing-done::after { display: none; }

        /* æ¸å˜èƒŒæ™¯ */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col overflow-hidden">

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between shadow-sm z-10">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 gradient-bg rounded-xl flex items-center justify-center text-white shadow-lg shadow-purple-200">
                <i class="fa-solid fa-wand-magic-sparkles text-xl"></i>
            </div>
            <div>
                <h1 class="font-bold text-slate-800 text-lg">Dify å·¥ä½œæµåŠ©æ‰‹</h1>
                <div class="flex items-center gap-2 text-xs text-slate-500">
                    <span id="status-indicator" class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span id="status-text">åœ¨çº¿</span>
                </div>
            </div>
        </div>

        <!-- ä¼šè¯ä¿¡æ¯ -->
        <div class="flex items-center gap-4">
            <!-- ä¼šè¯IDæ˜¾ç¤º -->
            <div class="hidden md:flex items-center gap-2 text-xs text-slate-500 bg-slate-100 px-3 py-2 rounded-lg">
                <i class="fa-solid fa-message"></i>
                <span>ä¼šè¯: <span id="conversation-display" class="font-mono text-slate-700">æ–°ä¼šè¯</span></span>
            </div>
            
            <!-- æ–°å»ºä¼šè¯æŒ‰é’® -->
            <button onclick="startNewConversation()" 
                class="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 transition-colors shadow-md">
                <i class="fa-solid fa-plus"></i>
                æ–°ä¼šè¯
            </button>
        </div>
    </header>

    <!-- èŠå¤©åŒºåŸŸ -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 scroll-smooth">
        
        <!-- æ¬¢è¿æ¶ˆæ¯ -->
        <div class="flex gap-4 max-w-3xl mx-auto message-anim">
            <div class="w-10 h-10 gradient-bg rounded-full flex-shrink-0 flex items-center justify-center text-white text-sm shadow-md">
                <i class="fa-solid fa-robot"></i>
            </div>
            <div class="flex-1 space-y-2">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-semibold text-slate-700">Dify åŠ©æ‰‹</span>
                    <span class="text-xs text-slate-400">åˆšåˆš</span>
                </div>
                <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 text-slate-700 leading-relaxed prose max-w-none">
                    <p>ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯åŸºäº <strong>Dify</strong> å·¥ä½œæµçš„æ™ºèƒ½åŠ©æ‰‹ã€‚</p>
                    <p>æˆ‘æ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š</p>
                    <ul>
                        <li><strong>æµå¼å“åº”</strong>ï¼šå®æ—¶æ˜¾ç¤ºå›ç­”ï¼Œæ‰“å­—æœºæ•ˆæœ</li>
                        <li><strong>å¤šè½®å¯¹è¯</strong>ï¼šè‡ªåŠ¨ç»´æŠ¤å¯¹è¯ä¸Šä¸‹æ–‡</li>
                        <li><strong>Markdown æ¸²æŸ“</strong>ï¼šæ”¯æŒä»£ç é«˜äº®ã€è¡¨æ ¼ç­‰</li>
                    </ul>
                    <p>è¯·éšæ—¶å‘æˆ‘æé—®ï¼</p>
                </div>
            </div>
        </div>

    </main>

    <!-- åº•éƒ¨è¾“å…¥æ  -->
    <div class="bg-white border-t border-slate-200 p-4">
        <div class="max-w-3xl mx-auto relative">
            <form id="chat-form" onsubmit="handleSubmit(event)" class="relative">
                <textarea 
                    id="user-input"
                    rows="1"
                    class="w-full bg-slate-50 border border-slate-200 text-slate-800 placeholder-slate-400 text-sm rounded-2xl focus:ring-2 focus:ring-purple-500 focus:border-transparent block pl-4 pr-24 py-3 resize-none shadow-inner transition-all" 
                    placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜... (Shift+Enter æ¢è¡Œ)"
                    onkeydown="handleEnter(event)"
                    oninput="autoResize(this)"
                ></textarea>
                <div class="absolute right-2 bottom-2 flex items-center gap-2">
                    <!-- åœæ­¢æŒ‰é’® -->
                    <button 
                        type="button" 
                        id="stop-btn"
                        onclick="stopGeneration()"
                        class="hidden p-1.5 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-all w-8 h-8 flex items-center justify-center shadow-md"
                        title="åœæ­¢ç”Ÿæˆ">
                        <i class="fa-solid fa-stop text-xs"></i>
                    </button>
                    <!-- å‘é€æŒ‰é’® -->
                    <button 
                        type="submit" 
                        id="send-btn"
                        class="p-1.5 gradient-bg text-white rounded-xl hover:opacity-90 focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed w-8 h-8 flex items-center justify-center shadow-md">
                        <i class="fa-solid fa-paper-plane text-xs"></i>
                    </button>
                </div>
            </form>
            <div class="text-center mt-2">
                <p class="text-xs text-slate-400">
                    åŸºäº Dify å·¥ä½œæµ Â· 
                    <span id="token-info" class="text-purple-500"></span>
                </p>
            </div>
        </div>
    </div>

    <script>
        // é…ç½® marked.js
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        // çŠ¶æ€ç®¡ç†
        let state = {
            conversationId: null,  // Dify è¿”å›çš„ä¼šè¯ID
            userId: 'user_' + Date.now(),  // ç”Ÿæˆå”¯ä¸€ç”¨æˆ·ID
            isProcessing: false,
            abortController: null  // ç”¨äºå–æ¶ˆè¯·æ±‚
        };

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const stopBtn = document.getElementById('stop-btn');
        const conversationDisplay = document.getElementById('conversation-display');

        // å¼€å§‹æ–°ä¼šè¯
        function startNewConversation() {
            state.conversationId = null;
            conversationDisplay.textContent = 'æ–°ä¼šè¯';
            appendSystemMessage('å·²å¼€å§‹æ–°çš„å¯¹è¯ä¼šè¯');
        }

        // æ›´æ–°ä¼šè¯IDæ˜¾ç¤º
        function updateConversationDisplay(conversationId) {
            if (conversationId) {
                state.conversationId = conversationId;
                // åªæ˜¾ç¤ºå‰8ä½
                conversationDisplay.textContent = conversationId.substring(0, 8) + '...';
                conversationDisplay.title = conversationId;
            }
        }

        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }

        // å¤„ç†å›è½¦å‘é€
        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSubmit(e);
            }
        }

        // åœæ­¢ç”Ÿæˆ
        function stopGeneration() {
            if (state.abortController) {
                state.abortController.abort();
                state.abortController = null;
            }
        }

        // æäº¤è¡¨å• - æ”¯æŒæµå¼å“åº”
        async function handleSubmit(e) {
            e.preventDefault();
            const question = userInput.value.trim();
            if (!question || state.isProcessing) return;

            // 1. æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            appendUserMessage(question);
            userInput.value = '';
            userInput.style.height = 'auto';
            
            // 2. é”å®šçŠ¶æ€
            state.isProcessing = true;
            state.abortController = new AbortController();
            sendBtn.disabled = true;
            sendBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            userInput.disabled = true;
            updateStatus('æ€è€ƒä¸­...', 'yellow');

            // 3. æ·»åŠ  Loading å ä½ç¬¦
            const loadingId = appendLoadingMessage();

            try {
                // 4. æ„å»ºè¯·æ±‚ä½“
                const requestBody = {
                    query: question,
                    userId: state.userId,
                    conversationId: state.conversationId,
                    inputs: {}
                };

                // 5. å‘é€æµå¼è¯·æ±‚
                const response = await fetch('/dify/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody),
                    signal: state.abortController.signal
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // 6. å¤„ç† SSE æµ
                await handleDifyStream(response, loadingId);

            } catch (error) {
                removeMessage(loadingId);
                if (error.name === 'AbortError') {
                    appendSystemMessage('ç”Ÿæˆå·²åœæ­¢');
                } else {
                    appendErrorMessage("æŠ±æ­‰ï¼ŒæœåŠ¡å™¨è¿æ¥å‡ºç°é—®é¢˜: " + error.message);
                    console.error('è¯·æ±‚é”™è¯¯:', error);
                }
            } finally {
                state.isProcessing = false;
                state.abortController = null;
                sendBtn.disabled = false;
                sendBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                userInput.disabled = false;
                userInput.focus();
                updateStatus('åœ¨çº¿', 'green');
            }
        }

        // å¤„ç† Dify SSE æµå¼å“åº”
        async function handleDifyStream(response, loadingId) {
            // ç§»é™¤ Loadingï¼Œåˆ›å»º AI æ¶ˆæ¯å®¹å™¨
            removeMessage(loadingId);
            const msgId = appendAIMessageContainer();

            // è¯»å–æµå¼æ•°æ®
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let fullText = '';

            console.log('å¼€å§‹è¯»å– Dify æµå¼æ•°æ®');

            while (true) {
                const { done, value } = await reader.read();
                
                if (done) {
                    console.log('æµè¯»å–å®Œæˆï¼Œæœ€ç»ˆæ–‡æœ¬é•¿åº¦:', fullText.length);
                    // æµç»“æŸï¼Œç§»é™¤æ‰“å­—å…‰æ ‡
                    const contentDiv = document.querySelector(`#${msgId} .prose`);
                    if (contentDiv) {
                        contentDiv.classList.add('typing-done');
                        // æœ€ç»ˆæ¸²æŸ“ä¸€æ¬¡ Markdownï¼ˆç¡®ä¿å®Œæ•´ï¼‰
                        if (fullText.trim()) {
                            contentDiv.innerHTML = marked.parse(fullText);
                            // é‡æ–°é«˜äº®ä»£ç å—
                            contentDiv.querySelectorAll('pre code').forEach((block) => {
                                hljs.highlightElement(block);
                            });
                        } else {
                            contentDiv.innerHTML = '<p class="text-slate-500">æœªæ”¶åˆ°å“åº”å†…å®¹</p>';
                        }
                    }
                    break;
                }

                // è§£ç æ•°æ®
                const chunk = decoder.decode(value, { stream: true });
                buffer += chunk;
                
                // å¤„ç† SSE æ ¼å¼çš„æ•°æ®ï¼ˆä»¥ \n\n åˆ†éš”äº‹ä»¶ï¼Œæˆ– \n åˆ†éš”è¡Œï¼‰
                const lines = buffer.split('\n');
                buffer = '';

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    // å¦‚æœæ˜¯æœ€åä¸€è¡Œä¸”ä¸ä¸ºç©ºï¼Œå¯èƒ½æ˜¯ä¸å®Œæ•´çš„æ•°æ®ï¼Œä¿ç•™åˆ°buffer
                    if (i === lines.length - 1 && line !== '') {
                        buffer = line;
                        continue;
                    }
                    
                    if (!line.trim()) continue; // è·³è¿‡ç©ºè¡Œ
                    
                    // å¤„ç† SSE æ ¼å¼ï¼šdata: {...} æˆ– data:{...}
                    let dataStr = null;
                    if (line.startsWith('data: ')) {
                        dataStr = line.substring(6).trim();
                    } else if (line.startsWith('data:')) {
                        dataStr = line.substring(5).trim();
                    } else {
                        // å¯èƒ½æ˜¯çº¯æ–‡æœ¬æµï¼ˆéSSEæ ¼å¼ï¼‰
                        // ç›´æ¥å°è¯•è§£æJSON
                        dataStr = line.trim();
                    }
                    
                    if (!dataStr || dataStr === '' || dataStr === '{}') {
                        continue;
                    }
                    
                    try {
                        const data = JSON.parse(dataStr);
                        console.log('Dify SSE äº‹ä»¶:', data.event, data);
                        
                        // å¤„ç† Dify çš„ä¸åŒäº‹ä»¶ç±»å‹
                        switch (data.event) {
                            case 'message':
                            case 'agent_message':
                                // æµå¼æ–‡æœ¬ç‰‡æ®µ
                                if (data.answer) {
                                    fullText += data.answer;
                                    updateAIMessageContent(msgId, fullText);
                                }
                                // ä¿å­˜ conversation_id
                                if (data.conversation_id) {
                                    updateConversationDisplay(data.conversation_id);
                                }
                                break;
                                
                            case 'message_end':
                            case 'agent_message_end':
                                // æ¶ˆæ¯ç»“æŸ
                                if (data.conversation_id) {
                                    updateConversationDisplay(data.conversation_id);
                                }
                                // æ˜¾ç¤º token ä½¿ç”¨æƒ…å†µ
                                if (data.metadata && data.metadata.usage) {
                                    const usage = data.metadata.usage;
                                    document.getElementById('token-info').textContent = 
                                        `Tokens: ${usage.total_tokens || 0}`;
                                }
                                break;
                                
                            case 'tts_message':
                                // TTS æ¶ˆæ¯ï¼Œå¿½ç•¥
                                break;
                                
                            case 'tts_message_end':
                                // TTS æ¶ˆæ¯ç»“æŸï¼Œå¿½ç•¥
                                break;
                                
                            case 'message_file':
                                // æ–‡ä»¶æ¶ˆæ¯
                                if (data.url) {
                                    fullText += `\n![æ–‡ä»¶](${data.url})\n`;
                                    updateAIMessageContent(msgId, fullText);
                                }
                                break;
                                
                            case 'error':
                                // é”™è¯¯äº‹ä»¶
                                console.error('Dify é”™è¯¯:', data);
                                const errorMsg = data.message || 'å‘ç”ŸæœªçŸ¥é”™è¯¯';
                                fullText += `\n\nâš ï¸ **é”™è¯¯**: ${errorMsg}`;
                                updateAIMessageContent(msgId, fullText);
                                break;
                                
                            case 'ping':
                                // å¿ƒè·³ï¼Œå¿½ç•¥
                                break;
                                
                            default:
                                // å…¶ä»–æœªçŸ¥äº‹ä»¶
                                console.log('æœªå¤„ç†çš„ Dify äº‹ä»¶:', data.event, data);
                                // å¦‚æœæœ‰ answer å­—æ®µï¼Œä»ç„¶å¤„ç†
                                if (data.answer) {
                                    fullText += data.answer;
                                    updateAIMessageContent(msgId, fullText);
                                }
                        }
                    } catch (parseError) {
                        // JSON è§£æå¤±è´¥ï¼Œå¯èƒ½æ˜¯çº¯æ–‡æœ¬
                        console.warn('è§£æ SSE æ•°æ®å¤±è´¥:', parseError.message, 'åŸå§‹æ•°æ®:', dataStr.substring(0, 100));
                    }
                }
            }
        }

        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatus(text, color) {
            const indicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            
            statusText.textContent = text;
            indicator.className = `w-2 h-2 rounded-full ${color === 'green' ? 'bg-green-500 animate-pulse' : color === 'yellow' ? 'bg-yellow-500 animate-pulse' : 'bg-red-500'}`;
        }

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        function appendUserMessage(text) {
            const html = `
                <div class="flex gap-4 max-w-3xl mx-auto flex-row-reverse message-anim">
                    <div class="w-10 h-10 bg-slate-200 rounded-full flex-shrink-0 flex items-center justify-center text-slate-600">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <div class="flex-1 space-y-2 text-right">
                        <div class="bg-purple-600 text-white p-4 rounded-2xl rounded-tr-none shadow-md inline-block text-left max-w-full">
                            <p class="whitespace-pre-wrap text-sm break-words">${escapeHtml(text)}</p>
                        </div>
                    </div>
                </div>
            `;
            chatContainer.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
        }

        // æ·»åŠ  AI æ¶ˆæ¯å®¹å™¨ï¼ˆç”¨äºæµå¼æ›´æ–°ï¼‰
        function appendAIMessageContainer() {
            const msgId = 'msg-' + Date.now();
            const html = `
                <div class="flex gap-4 max-w-3xl mx-auto message-anim" id="${msgId}">
                    <div class="w-10 h-10 gradient-bg rounded-full flex-shrink-0 flex items-center justify-center text-white text-sm shadow-md">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <div class="flex-1 space-y-2 min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-semibold text-slate-700">Dify åŠ©æ‰‹</span>
                            <span class="text-xs text-slate-400">${new Date().toLocaleTimeString()}</span>
                        </div>
                        <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 text-slate-700 leading-relaxed prose max-w-none cursor">
                            <p class="text-slate-400">æ­£åœ¨æ€è€ƒ...</p>
                        </div>
                    </div>
                </div>
            `;
            chatContainer.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
            return msgId;
        }

        // æ›´æ–° AI æ¶ˆæ¯å†…å®¹ï¼ˆå®æ—¶æµå¼æ›´æ–°ï¼‰
        function updateAIMessageContent(msgId, text) {
            const contentDiv = document.querySelector(`#${msgId} .prose`);
            if (!contentDiv) {
                console.warn('æ‰¾ä¸åˆ°æ¶ˆæ¯å®¹å™¨ï¼ŒmsgId:', msgId);
                return;
            }

            try {
                if (text.trim()) {
                    contentDiv.innerHTML = marked.parse(text);
                    // é«˜äº®ä»£ç å—
                    contentDiv.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                } else {
                    contentDiv.innerHTML = '<p class="text-slate-400">æ­£åœ¨æ€è€ƒ...</p>';
                }
                scrollToBottom();
            } catch (error) {
                console.error('æ¸²æŸ“ Markdown å¤±è´¥:', error);
                contentDiv.textContent = text;
            }
        }

        // æ·»åŠ  Loading æ¶ˆæ¯
        function appendLoadingMessage() {
            const id = 'loading-' + Date.now();
            const html = `
                <div class="flex gap-4 max-w-3xl mx-auto message-anim" id="${id}">
                    <div class="w-10 h-10 gradient-bg rounded-full flex-shrink-0 flex items-center justify-center text-white text-sm shadow-md">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 w-24">
                        <div class="flex items-center gap-1 h-6">
                            <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                            <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                            <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                        </div>
                    </div>
                </div>
            `;
            chatContainer.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
            return id;
        }

        // æ·»åŠ ç³»ç»Ÿæç¤ºæ¶ˆæ¯
        function appendSystemMessage(text) {
            const html = `
                <div class="flex justify-center my-4 message-anim">
                    <span class="text-xs text-slate-400 bg-slate-100 px-3 py-1 rounded-full">
                        <i class="fa-solid fa-info-circle mr-1"></i>${text}
                    </span>
                </div>
            `;
            chatContainer.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
        }

        // æ·»åŠ é”™è¯¯æ¶ˆæ¯
        function appendErrorMessage(text) {
            const html = `
                <div class="flex gap-4 max-w-3xl mx-auto message-anim">
                    <div class="w-10 h-10 bg-red-500 rounded-full flex-shrink-0 flex items-center justify-center text-white text-sm shadow-md">
                        <i class="fa-solid fa-exclamation"></i>
                    </div>
                    <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-red-200 text-red-600">
                        <p class="font-medium mb-1">å‡ºé”™äº†</p>
                        <p class="text-sm">${escapeHtml(text)}</p>
                    </div>
                </div>
            `;
            chatContainer.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
        }

        // ç§»é™¤æ¶ˆæ¯
        function removeMessage(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // é¡µé¢åŠ è½½å®Œæˆåèšç„¦è¾“å…¥æ¡†
        window.onload = function() {
            userInput.focus();
        };
    </script>
</body>
</html>
